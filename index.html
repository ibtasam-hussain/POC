<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Barcode Scanner</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .container {
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
      padding: 40px;
      max-width: 600px;
      width: 90%;
      text-align: center;
    }
    h1 { color: #333; margin-bottom: 30px; font-size: 2.5rem; }
    .upload-area {
      border: 3px dashed #667eea;
      border-radius: 15px;
      padding: 40px 20px;
      margin: 30px 0;
      transition: all 0.3s ease;
      cursor: pointer;
    }
    .upload-area:hover {
      border-color: #764ba2;
      background-color: #f8f9ff;
    }
    .upload-area.dragover {
      border-color: #764ba2;
      background-color: #f0f2ff;
    }
    .upload-icon {
      font-size: 3rem;
      color: #667eea;
      margin-bottom: 20px;
    }
    .upload-text { color: #666; font-size: 1.1rem; margin-bottom: 20px; }
    input[type="file"] { display: none; }
    .btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white; border: none;
      padding: 15px 30px; border-radius: 50px;
      font-size: 1.1rem; cursor: pointer;
      transition: all 0.3s ease; margin: 10px;
    }
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(102,126,234,0.3);
    }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
    .preview { margin: 30px 0; }
    .preview img {
      max-width: 100%; max-height: 300px;
      border-radius: 15px;
      box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }
    .result {
      margin: 30px 0; padding: 20px;
      border-radius: 15px;
      font-size: 1.1rem;
      min-height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .result.success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .result.error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    .result.loading { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
    .loading-spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      width: 30px; height: 30px;
      animation: spin 1s linear infinite;
      margin-right: 10px;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .hidden { display: none; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîç Barcode Scanner</h1>

    <div class="upload-area" id="uploadArea">
      <div class="upload-icon">üìÅ</div>
      <div class="upload-text">Click here or drag & drop your image</div>
      <input type="file" id="fileInput" accept="image/*">
      <button class="btn" onclick="document.getElementById('fileInput').click()">Choose Image</button>
    </div>

    <div class="preview hidden" id="preview">
      <img id="previewImg" alt="Preview">
    </div>

    <button class="btn" id="scanBtn" onclick="scanBarcode()" disabled>Scan Barcode</button>

    <div class="result hidden" id="result">
      <div id="resultContent"></div>
    </div>
  </div>

  <script>
    const fileInput = document.getElementById('fileInput');
    const uploadArea = document.getElementById('uploadArea');
    const preview = document.getElementById('preview');
    const previewImg = document.getElementById('previewImg');
    const scanBtn = document.getElementById('scanBtn');
    const result = document.getElementById('result');
    const resultContent = document.getElementById('resultContent');
    let selectedFile = null;

    // ===== FILE HANDLING =====
    fileInput.addEventListener('change', handleFileSelect);
    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault(); uploadArea.classList.add('dragover');
    });
    uploadArea.addEventListener('dragleave', () => {
      uploadArea.classList.remove('dragover');
    });
    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault(); uploadArea.classList.remove('dragover');
      const files = e.dataTransfer.files;
      if (files.length > 0) handleFile(files[0]);
    });
    uploadArea.addEventListener('click', () => fileInput.click());

    function handleFileSelect(e) {
      const file = e.target.files[0];
      if (file) handleFile(file);
    }

    function handleFile(file) {
      if (!file.type.startsWith('image/')) {
        showResult('Please select a valid image file.', 'error');
        return;
      }
      selectedFile = file;
      const reader = new FileReader();
      reader.onload = (e) => {
        previewImg.src = e.target.result;
        preview.classList.remove('hidden');
        scanBtn.disabled = false;
      };
      reader.readAsDataURL(file);
    }

    // ===== MAIN SCAN FUNCTION =====
    async function scanBarcode() {
      if (!selectedFile) return;

      const formData = new FormData();
      formData.append('image', selectedFile);

      showResult('Scanning barcode...', 'loading');

      try {
        const response = await fetch('http://localhost:3000/scan', {
          method: 'POST',
          body: formData
        });
        const data = await response.json();
        console.log('Response from backend:', data);

        if (data.success) {
          if (data.parsed && Object.keys(data.parsed).length > 0) {
            let html = `<h3>üìã Parsed License Data</h3>
              <table style="width:100%;border-collapse:collapse;text-align:left;">`;
            for (const [key, value] of Object.entries(data.parsed)) {
              html += `<tr>
                <td style="padding:6px 10px;border-bottom:1px solid #eee;font-weight:600;">${key}</td>
                <td style="padding:6px 10px;border-bottom:1px solid #eee;">${value || '-'}</td>
              </tr>`;
            }
            html += `</table>`;
            showResult(html, 'success');
          } else {
            showResult(`Raw Data: ${data.raw || 'No parsed data found.'}`, 'success');
          }
        } else {
          showResult(data.message || 'No barcode found.', 'error');
        }

      } catch (err) {
        console.error(err);
        showResult('Error connecting to backend.', 'error');
      }
    }

    // ===== SHOW RESULT FUNCTION (GLOBAL) =====
    function showResult(message, type) {
      resultContent.innerHTML =
        type === 'loading'
          ? '<div class="loading-spinner"></div>' + message
          : message;

      result.className = `result ${type}`;
      result.classList.remove('hidden');
    }
  </script>
</body>
</html>
